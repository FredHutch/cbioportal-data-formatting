---
title: "Bulk Variant Filtering and MAF creation for cbioportal"
author: "Amy Paguirigan"
date: "2/17/2021"
output: html_document
---
# Prep
```{r}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("maftools")
```

```{r}
library(tidyverse); library(aws.s3); library(tgR); library(furrr); library(maftools)
setCreds(path = "~/github/cred/paguirigan.R")
```

# Pull S3 Inventory and Annotate
```{r}
bucket <- "fh-pi-paguirigan-a-eco"; DAG  <- "paguirigana"
tags <- listS3Objects(bucket = bucket)
annotations <- tgrAnnotate( harmonizedOnly = FALSE)
monsterMash <- dplyr::left_join(tags, annotations) %>% dropWhen()

onlythese <- monsterMash %>% filter(genomics_type == "dnaseq" & seq_libtype == "one" & workflowName == "ITH_HALO_CARD" & workflowOutputType == "consensusVariants"  ) %>% dropWhen()
unique(onlythese$workflowOutputType)
```

# Validation Data cohort
```{r}
selectedData <- onlythese %>% filter(study_id == "Validation") %>% dropWhen()

selectedData %>% group_by(seq_pool) %>% summarize(n_distinct(molecular_id))
```

# Pull down, filter and collect data
```{r}
results <- map(seq(1:nrow(selectedData)), function(x){
  instruction <- selectedData[x,]
  snark <- s3read_using(read.table, stringsAsFactors = F, header = T, 
                        object = instruction$key, 
                        bucket = instruction$piBucket)
  snark <- snark %>% select(-starts_with(c("Mutation", "PROVEAN", "FATHMM", "Meta", "M.CAP", "MutPred", "fathmm", "Eigen", "integrated", "GERP", "phylo", "phast", "SIFT", "LRT", "SiPhy", "GenoCanyon", "GTex")))
  snark <- snark %>% 
    filter(!ExonicFunc.refGene %in% c("synonymous SNV", ".", "unknown")) %>%
    filter(FILTER.Mu == "PASS" & is.na(AD.SAM)==F & is.na(AD.GATK)==F |  # all three callers
             FILTER.Mu == "PASS" & is.na(AD.GATK)==F |  # pass for Mutect, and called by GATK too - NPM1 falls here
             is.na(AD.SAM)==F  & is.na(AD.GATK)==F | # regardless of mutect, if called by both others
             grepl("germline", FILTER.Mu) ==T  & is.na(AD.GATK)==F | # GATK, and germline, any samtools
             grepl("slippage", FILTER.Mu) ==T  & is.na(AD.GATK)==F | # GATK, and contains slippage filter for Mutect, any samtools
             FILTER.Mu == "clustered_events" & is.na(AD.SAM)==F & is.na(AD.GATK)==F # Mutect clustered events, and both other callers
             ) 
  snark$ExAC_ALL[grepl("^\\.$",snark$ExAC_ALL)] <- 0
  snark$ExAC_ALL <- as.numeric(snark$ExAC_ALL)
  snark <- snark %>% filter(ExAC_ALL < 0.05) 
  
  snark <- snark %>% 
    mutate(VAF = rowMeans(select(snark, VAF.GATK, VAF.SAM, VAF.Mu), na.rm = T)) %>% 
    mutate(DP = rowMeans(select(snark, DP.GATK, DP.SAM, DP.Mu), na.rm = T)) %>% 
    mutate(AD = rowMeans(select(snark, AD.GATK, AD.SAM, AD.Mu), na.rm = T)) %>% 
    filter(AD > 10)
  return(snark)
}) 
names(results) <- selectedData$molecular_id

res1 <- map_dfr(results, rbind, .id = "molecular_id")

n_distinct(res1$molecular_id)
```

# Make into a MAF
```{r}
res1$Tumor_Sample_Barcode <- res1$molecular_id
write_delim(res1, "data/2021-02-17-mafattempt.txt", delim = "\t")
forMaf <-annovarToMaf("data/2021-02-17-mafattempt.txt", Center = "NA", refBuild = "hg38")

```

# Apply relevant annotations
```{r}
annot <- selectedData %>% select(molecular_id, seq_flowcell_id, age_range, tissue_type, seq_pool, study_id, biospecimen_id) %>% rename("Tumor_Sample_Barcode" = "molecular_id")


usefulMAF <- read.maf(maf = forMaf, clinicalData = annot)

write.mafSummary(usefulMAF, basename = "data/2021-02-17-validationData")
```


# Maftools summary functions
```{r}
getSampleSummary(usefulMAF)
getGeneSummary(usefulMAF)
getFields(usefulMAF)

```

# Maftools plots
```{r}
plotmafSummary(maf = usefulMAF, rmOutlier = TRUE, addStat = 'median', dashboard = TRUE, titvRaw = FALSE)
oncoplot(usefulMAF)
lollipopPlot(maf = usefulMAF, gene = 'DNMT3A', AACol = 'aaChange', showMutationRate = TRUE)
rainfallPlot(maf = usefulMAF, detectChangePoints = TRUE, pointSize = 0.4)
plotVaf(maf = usefulMAF, vafCol = 'VAF')
```




```{r}
somaticInteractions(maf = usefulMAF, top = 25, pvalue = c(0.05, 0.1))
```

